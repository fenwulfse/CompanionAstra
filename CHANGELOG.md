# Changelog

## 2026-02-19
- Night dialogue-bridge candidate deployed (target: no-talk/stare regression):
  - Source updates in `CompanionAstra_LockedIDs/Program.cs`:
    - Added `Voices_CompanionsFaction` to Astra actor factions for closer Piper parity.
    - Added Action-1 pickup `SharedDialog` links on Astra-owned topics:
      - `PPos -> 162C70`, `NPos -> 162C6F`,
      - `PNeg -> 162DFB`, `NNeg -> 162D6A`,
      - `PNeu -> 162C82`, `NNeu -> 162C7D`,
      - `PQue -> 162C74`, `NQue -> 1A4EAB`.
    - Added default voice-copy mappings for Action-1 pickup lines:
      - NPC: `162C6F/162D6A/162C7D/1A4EAB` -> `0000095D/61/65/69`
      - Player: `162C70/162DFB/162C82/162C74` -> `0000095B/5F/63/67`
  - Build/deploy fingerprint:
    - ESP `E896A5B5F02EB2A3093C67792A35D9CA3DC816A842F56C79998011FB29A5EE05`
    - size/time `73096` bytes, `2026-02-18 20:45:56`
    - PEX `B86E464BE9E4C79039FC2CE7CEA1DB397F0AFA3836225AE6BA3A4B1F790CDE46`
    - PSC `BF1537DC9D9AE0E0DFD9810F626F35A39B545CA22CA790121D01B9E961661D8A`
  - Voice verification:
    - Action-1 line assets now present in deployed voice tree:
      - `NPCFAstra`: `0000095D`, `00000961`, `00000965`, `00000969`
      - `PlayerVoiceMale01/PlayerVoiceFemale01`: `0000095B`, `0000095F`, `00000963`, `00000967`
    - total voice count now `254` (`NPCFAstra=82`, `male=80`, `female=80`).
  - Safety checkpoint:
    - `Backups/WorkingHistory/2026-02-18_204710_2026-02-18_night_dialogue_voice_bridge_candidate`
- Async coordination refresh for overnight progress:
  - Updated `COMM_CODEX_TO_CLAUDE.md` with 2026-02-19 scope:
    - no duplicate Astra mechanics edits,
    - requested property parity checklist + Phase 2 insertion order in Claude-owned paths.
  - Updated `COMM_CODEX_TO_GEMINI.md` with 2026-02-19 scope:
    - Papyrus error-to-property mapping + repro matrix docs only.
  - Added `COMM_CODEX_TO_COPILOT.md`:
    - safe docs/tool-only queue to use Copilot without touching deployed mechanics.
  - Added `Tools/VerifyLockedIDConsistency.ps1`:
    - compares hex FormID usage in `CompanionAstra_LockedIDs/Program.cs` vs `docs/*LOCKED_IDS*.md`.
    - first run confirms drift report generation is working and highlights one docs-only ID: `0x000E576F`.
- Collaboration and human-testing infrastructure added:
  - New protocol doc: `docs/TEAM_COLLAB_PROTOCOL.md`
    - defines strict multi-agent boundaries, deploy ownership, merge gates, and incident workflow.
  - New GitHub issue template: `.github/ISSUE_TEMPLATE/playtest-run.md`
    - standardizes outside tester requests with exact build fingerprints and required checks.
  - New packaging tool: `Tools/create_playtest_packet.ps1`
    - generates reproducible playtest packet with ESP/PEX/PSC artifacts, SHA256 manifest, and checklist.
  - Docs linked from:
    - `README.md`
    - `docs/WIKI_INDEX.md`
    - `CONTRIBUTING.md`

## 2026-02-18
- Emergency talk-safe candidate deployed (minimal greeting routing):
  - User report remained: no talk + player movement lock while interacting with Astra.
  - Source changes in `CompanionAstra_LockedIDs/Program.cs`:
    - pickup/dismiss greeting `StartScenePhase` cleared to empty string.
    - final `COMAstraGreetings` ordering forced to only 3 responses:
      - `0000F0E1` (return pickup), `0000F0E0` (first pickup), `0000098A` (dismiss).
    - affinity/repeater forcegreet responses temporarily excluded from active greeting topic to avoid dialogue dead-ends.
  - Build/deploy:
    - active `Data\\CompanionAstra.esp` hash `7D066C9D798490FC18636D22B6349889DFDC593D79E54700A4FBE06513410086`
    - size/time: `73659` bytes, `2026-02-18 19:18:25`
  - Verification:
    - inspector shows `COMAstraGreetings` response count now `3` with only pickup/return/dismiss entries.
  - Playtest packet:
    - `Backups/PlaytestPackets/2026-02-18_191901_talksafe_greeting_minimal_candidate`
- Emergency talk-lock correction deployed (hybrid pickup routing):
  - Symptom from user test:
    - pressing Talk could lock player in place (jump works, movement blocked), with Astra non-responsive.
  - Root-cause candidate:
    - prior build switched `COMAstraPickupScene` Action 1 PlayerDialogue slots to Piper vanilla topics, which can dead-end in custom quest context.
  - Source change in `CompanionAstra_LockedIDs/Program.cs`:
    - Action 1 reverted to Astra-owned topics (`COMAstraPickup_PPos/NPos/PNeg/NNeg/PNeu/NNeu/PQue/NQue`).
    - Action 2/3/4/5 kept Piper-routed (`162C4B`, `162C4A`, `21748C`, `21748B`) to preserve handoff structure.
  - Build/deploy:
    - active `Data\\CompanionAstra.esp` hash `7A9AE1A4150337EDDC5ABEFF6696043DBFDED31BB243E81D0C7A8836A015C26C`
    - size/time: `79229` bytes, `2026-02-18 18:57:40`
  - Verification:
    - `Tools/InspectAstraPickup` confirms hybrid routing:
      - Action1 -> Astra topics
      - Action2-5 -> Piper/vanilla topics as listed above.
- Pickup routing stabilization candidate deployed (Piper-exact topics):
  - Trigger:
    - live scene inspection showed `COMAstraPickupScene` Action 2/3/4 were still Astra-owned custom topics (`COMAstraPickup_Dialog*`), which removed vanilla companion exchange routing and correlated with non-interactive talk regressions.
  - Source change in `CompanionAstra_LockedIDs/Program.cs`:
    - `COMAstraPickupScene` Action 1 now uses Piper vanilla response topics:
      - `PPos 162C4F`, `NPos 162C53`, `PNeg 162C4E`, `NNeg 162C52`, `PNeu 162C4D`, `NNeu 162C51`, `PQue 162C4C`, `NQue 162C50`.
    - Action topics now Piper-exact:
      - `Action2 162C4B`, `Action3 162C4A`, `Action4 21748C`, `Action5 21748B`.
  - Build/deploy:
    - active `Data\\CompanionAstra.esp` hash `4D171835CF1DEA00637D48AD46C2B69CBF1BE4DC90F11793F834FD1CE335ADFE`
    - size/time: `79229` bytes, `2026-02-18 18:36:31`
    - `plugins.txt` remains `*CompanionAstra.esp`
  - Verification:
    - `Tools/InspectAstraPickup` confirms `COMAstraPickupScene` now matches `COMPiperPickupScene` topic wiring exactly for actions 1-5.
  - Safety checkpoint:
    - `Backups/WorkingHistory/2026-02-18_183724_pickup_piper_exact_candidate`
- EditorID cleanup test deploy:
  - Source update in `CompanionAstra_LockedIDs/Program.cs`:
    - renamed scene/topic EditorIDs from `COMClaude*` to `COMAstra*` (legacy constant kept as `COMClaude` for compatibility handling).
  - Trigger:
    - CK `EditorWarnings.txt` `<CURRENT>` lines showed StartPhase index/name mismatches on Astra INFO records (`0100F30B/11`, `0100F40B/11/17`, `0100F50B/11/17/1D/23`, plus `0100098A/8C`).
  - Deployed candidate:
    - previous ESP SHA256 `7B8151E9F61A376AE7CC405EB16171D16B80CB786CB405916C722500386E5D38`
    - new ESP SHA256 `197B737D8216165263415F6008E40EE62324076C22732E547B5FA602F4437DB6`
    - active plugin: `*CompanionAstra.esp`
  - Safety snapshot:
    - `Backups/WorkingHistory/2026-02-18_181816_editorid_cleanup_candidate_deploy`
  - Non-target assets intentionally unchanged:
    - `QF_COMAstra_00000805.pex` SHA256 `70864D0F8493EC5CBB0830E97F6331AEFC74FD5439CC32D6D285EACD8145A765`
    - voice folder remains `246` files / `15` dirs.
- Runtime-root-cause fix candidate deployed (actor VMAD parity):
  - Papyrus evidence from `Papyrus.0.log` showed `CompanionActorScript` errors on Astra form `07000804`:
    - `GetNextThreshold()` line `1207`: `ThresholdData_Array[0]` access on `None`.
    - cascading `None`/array errors in `TestValueForAffinityBump()` during `FollowersScript_CompanionChange`.
  - Source fix in `CompanionAstra_LockedIDs/Program.cs`:
    - actor VMAD now cloned from `CompanionPiper` instead of minimal custom script list.
    - Astra overrides still enforced (`DismissScene`, workshop flags, core globals/AVs).
  - Build/deploy:
    - previous ESP hash: `89C7F3843FD345A820D7BF9A09145CCBB1E5891A677C7F5EED6366974CC00D64`
    - deployed candidate ESP hash: `7B8151E9F61A376AE7CC405EB16171D16B80CB786CB405916C722500386E5D38`
    - deployed size/time: `79393` bytes, `2026-02-18 14:17`
  - Safety checkpoint:
    - `Backups/WorkingHistory/2026-02-18_141743_vmad_thresholddata_fix_candidate`
    - contains `BeforeDeploy/CompanionAstra.esp` and `Candidate/CompanionAstra.esp`.
  - Deployment invariants rechecked:
    - `plugins.txt`: `*CompanionAstra.esp`
    - scripts unchanged: `QF_COMAstra_00000805.pex` SHA256 `70864D0F8493EC5CBB0830E97F6331AEFC74FD5439CC32D6D285EACD8145A765`
    - voice set unchanged: `246` `.fuz`, `15` dirs.
- Offline fix candidate prepared (not deployed to live `Data`):
  - Candidate folder:
    - `Backups/Candidates/2026-02-18_action2_astra_owned`
  - Targeted pickup fix:
    - `COMAstraPickupScene` Action 2 switched from vanilla topic `Fallout4.esm:162C4B` to Astra-owned `COMAstraPickup_Dialog2`.
  - Rationale:
    - avoid vanilla-topic condition dead-end in custom quest context that can stall interaction.
  - Candidate deploy set includes coherent artifacts:
    - ESP `89C7F3843FD345A820D7BF9A09145CCBB1E5891A677C7F5EED6366974CC00D64`
    - PEX `70864D0F8493EC5CBB0830E97F6331AEFC74FD5439CC32D6D285EACD8145A765`
    - PSC `BF1537DC9D9AE0E0DFD9810F626F35A39B545CA22CA790121D01B9E961661D8A`
    - Voice set `246` files with companion fallback dirs.
- Emergency loop break (latest-test regression -> stable baseline restore):
  - User reported repeat non-interactive companion talk and player-in-place lock during interaction attempts.
  - Reverted runtime from latest-test set back to known playable baseline:
    - ESP: `20D2595BB4028D48DE7C97119D5C58AF0716F2C1D22534CE8652F0E414BC87A8`
    - PEX: `70864D0F8493EC5CBB0830E97F6331AEFC74FD5439CC32D6D285EACD8145A765`
    - PSC: `BF1537DC9D9AE0E0DFD9810F626F35A39B545CA22CA790121D01B9E961661D8A`
    - Voice: `227` total (`NPCFAstra=71`)
  - Kept CK-clean script source placement:
    - present: `Data\Scripts\Source\User\Fragments\Quests\QF_COMAstra_00000805.psc`
    - absent by design: `Data\Scripts\Source\User\QF_COMAstra_00000805.psc`
  - Active plugin reconfirmed:
    - `plugins.txt` -> `*CompanionAstra.esp`
  - Pinned checkpoint for this recovered state:
    - `Backups/WorkingHistory/2026-02-18_132928_stable_baseline_recovered_after_loop_2026-02-18_`
- Current-state recovery hardening (afternoon pass):
  - Confirmed runtime confusion cause: mixed deployment state.
  - `plugins.txt` had wrong active plugin (`*CompanionClaude.esp`) during part of testing; corrected to `*CompanionAstra.esp`.
  - Live runtime had latest-test ESP (`F25979E8...`) but older 227-file voice set, causing partial/silent pickup behavior.
  - Restored matching voice set from the same latest-test checkpoint:
    - voice dirs now include fallback companions (`NPCFPiper`, `NPCFCait`, `NPCFCurie`, `NPCM*`, `RobotMrHandy`) plus player folders.
    - live voice count now `246` (`NPCFAstra=78`).
  - Created pinned checkpoint for this coherent state:
    - `Backups/WorkingHistory/2026-02-18_130832_latest_test_matched_voice_and_active_plugin_2026`
  - Technical fingerprint for current test state:
    - ESP `F25979E80060425051258060AF1CA7065E1E67622ECF62CB445B177136E281F0`
    - PEX `70864D0F8493EC5CBB0830E97F6331AEFC74FD5439CC32D6D285EACD8145A765`
    - PSC `BF1537DC9D9AE0E0DFD9810F626F35A39B545CA22CA790121D01B9E961661D8A`
    - Active plugin `*CompanionAstra.esp`
- User morning handoff retest reported:
  - No handoff exchange lines fired for `Astra <-> Codsworth`, `Astra <-> Dogmeat`, and additional checks with Piper/Cait.
  - Core flow remained stable: pickup/dismiss/menu/switch/exit all working.
- Root-cause confirmation via live scene inspection:
  - `COMAstraPickupScene` Action 2 was using custom topic `COMAstraPickup_Dialog2` (INFO `0000096B`) spoken by Alias 1.
  - Deployed voice pack previously lacked non-Astra companion folders, so Alias 1 lines were effectively silent.
  - Action 5 was bound to custom blank topic `COMAstraPickup_Dialog5` instead of a vanilla Dogmeat bark topic.
- Patch applied (minimal-risk, pickup-flow only):
  - `COMAstraPickupScene` Action 2 topic changed to vanilla companion handoff topic `Fallout4.esm:162C4B`.
  - `COMAstraPickupScene` Action 5 topic changed to vanilla Dogmeat bark topic `Fallout4.esm:21748B`.
  - Regenerated ESP + voice with greeting/dismiss TTS flags from project root.
  - Voice output now includes fallback companion directories:
    - `NPCFPiper`, `NPCFCait`, `NPCFCurie`, `NPCMPrestonGarvey`, `NPCMNickValentine`, `NPCMMacCready`,
      `NPCMHancock`, `NPCMDeacon`, `NPCMPaladinDanse`, `NPCMStrong`, `NPCMX6-88`, `RobotMrHandy`.
- Deploy + fingerprint:
  - Deployed ESP SHA256: `F25979E80060425051258060AF1CA7065E1E67622ECF62CB445B177136E281F0`
  - Deployed voice dirs now include: `NPCFAstra`, companion fallback dirs above, `PlayerVoiceMale01`, `PlayerVoiceFemale01`.
- Safety artifacts:
  - Pre-deploy backup: `<WORKSPACE_ROOT>/Backups/PreDeploy_HandoffPatch_2026-02-18_100704`
  - Full checkpoint: `<WORKSPACE_ROOT>/ChatGPT/CompanionAstra/Backups/WorkingHistory/2026-02-18_100738_2026-02-18_pickup_handoff_topic_patch_action2_5`
- VMAD fragment skip-list parity update (source-only, not deployed in this handoff test):
  - Corrected stage-fragment skip list in `CompanionAstra_LockedIDs/Program.cs`.
  - Old skip items removed: `630`, `1010`.
  - Correct no-fragment skip items added: `540`, `600`, `1000`.
- Regression observed in handoff-topic patch test:
  - User reported `Astra` became non-interactive after handoff attempts and game hung during later save load.
  - Immediate rollback performed to pre-deploy known-good runtime artifacts.
- Emergency rollback actions:
  - Force-stopped hung `Fallout4.exe`.
  - Restored ESP from pre-deploy backup:
    - `<WORKSPACE_ROOT>/Backups/PreDeploy_HandoffPatch_2026-02-18_100704/CompanionAstra.esp`
    - Live hash after restore: `20D2595BB4028D48DE7C97119D5C58AF0716F2C1D22534CE8652F0E414BC87A8`
  - Restored voice pack to known-good checkpoint snapshot:
    - Source: `Backups/WorkingHistory/2026-02-17_195509_2026-02-17_voice_pickup_dismiss_affinity_reset_o/Deployed/Sound/Voice/CompanionAstra.esp`
    - Live voice set normalized to:
      - dirs: `NPCFAstra`, `PlayerVoiceFemale01`, `PlayerVoiceMale01`
      - counts: `total=227`, `NPCFAstra=71`
  - Main quest fragment script remained on previously repaired hash:
    - `QF_COMAstra_00000805.pex` SHA256 `70864D0F8493EC5CBB0830E97F6331AEFC74FD5439CC32D6D285EACD8145A765`
- User validation after rollback (2026-02-18 morning follow-up):
  - Tested on:
    - brand new game
    - long-play Castle save
  - Confirmed working:
    - pickup
    - dismiss
    - follower switch flow remains stable
  - Still missing:
    - exchange lines for `Astra <-> Codsworth`
    - exchange lines for `Astra <-> Dogmeat`
- Baseline checkpoint captured:
  - `<WORKSPACE_ROOT>/ChatGPT/CompanionAstra/Backups/WorkingHistory/2026-02-18_110434_2026-02-18_verified_newgame_castle_pickup_dismis`

## 2026-02-17
- Incident diagnosis and recovery for "companions not talking" reports:
  - Confirmed last-night handoff notes in `HANDOVER_CODEX.md` (`LastWriteTime: 2026-02-16 21:05`).
  - Verified deployed voice files are structurally valid (`184/184` modern `FUZE + audio + lip`, `RIFF` audio headers).
  - Found a critical generation pitfall:
    - Running generator from `<WORKSPACE_ROOT>` sets `repoRoot` incorrectly.
    - Voice source lookup then misses project voice archive and logs many `MISSING` lines (partial output only).
  - Re-ran generator from correct working directory:
    - `<WORKSPACE_ROOT>\ChatGPT\CompanionAstra`
    - Command: `dotnet run --project .\CompanionAstra_LockedIDs\CompanionClaude_v13.csproj -- --tools-root <WORKSPACE_ROOT>\Tools --enable-greeting-tts --enable-dismiss-tts`
    - Result: `Copied 163 voice files total.`
  - Synced generated plugin to game Data:
    - Source hash `9D5B02C887C5998D78714CBEA9183B50C9C803F1FD2356F73AD133E7C07DAE4F`
    - Destination hash matched after deploy.
- Environment note from current Papyrus logs:
  - No `COMAstra`/`CompanionAstra` errors present in `Papyrus.0-3.log`.
  - Logs show heavy global script binding/scene-start errors (DLC/CC/vanilla) and VM freeze/revert events.
- Rolled back to pre-voice-update known-good snapshot for isolation test:
  - Snapshot deployed: `Backups/2026-02-11_084347_good_build_2026-02-11_morning`
  - Deployed to game:
    - `Data/CompanionAstra.esp` (snapshot build)
    - `Data/Scripts/Fragments/Quests/QF_COMAstra_00000805.pex`
    - `Data/Scripts/Fragments/Quests/QF_COMAstra_Test_000009A1.pex`
    - `Data/Scripts/Source/User/Fragments/Quests/QF_COMAstra_Test_000009A1.psc`
  - Temporarily disabled custom voice folder for strict "plugin-only" test by moving:
    - `Data/Sound/Voice/CompanionAstra.esp`
    - moved to backup archive `<WORKSPACE_ROOT>/Backups/RollbackPreVoice_2026-02-17_190605/CompanionAstra.esp_voice_folder`
  - Full rollback backup archive:
    - `<WORKSPACE_ROOT>/Backups/RollbackPreVoice_2026-02-17_190605`
- Restored matched Feb-16 package from disaster archive to fix ESP/voice mismatch:
  - Source package: `<WORKSPACE_ROOT>/ChatGPT/_disaster_eval/113542/deployed`
  - Deployed ESP hash: `20D2595BB4028D48DE7C97119D5C58AF0716F2C1D22534CE8652F0E414BC87A8`
  - Deployed voice set: `227` total `.fuz`, `71` in `NPCFAstra`
  - Deployment safety backup:
    - `<WORKSPACE_ROOT>/Backups/PreRestore_113542_2026-02-17_191312`
- User validation on restored package:
  - `Pickup`: working
  - `Astra voice`: working
  - `Dismiss`: still broken (cannot dismiss)
  - This state is now treated as a checkpoint candidate for future rollback.
- Created disaster-checkpoint backup for this exact state:
  - Folder checkpoint (source + deployed + notes):  
    `<WORKSPACE_ROOT>/ChatGPT/CompanionAstra/Backups/WorkingHistory/2026-02-17_1918_voice_pickup_ok_dismiss_broken`
  - Notes file in checkpoint:  
    `NOTES_THIS_BUILD.md`
  - ZIP archive + hash:  
    `<WORKSPACE_ROOT>/Backups/DH/CompanionAstra_disaster_backup_20260217_vok_pok_dbad.zip`  
    `<WORKSPACE_ROOT>/Backups/DH/CompanionAstra_disaster_backup_20260217_vok_pok_dbad.zip.sha256`
- Dismiss forensic clarification added:
  - `docs/DISMISS_FORENSICS_2026-02-17.md`
  - Confirms by source diff that:
    - Feb 11 and Feb 16 share the same dismiss routing block.
    - `workshopnpcscript` exists in recovered Feb 16 working source but not Feb 11 snapshot.
  - Working rule: keep workshop support for vanilla-like settlement dismiss behavior.
  - Added vanilla companion-script context note (`COM*Script` tie-ins and cross-name reference risk).
- Dismiss-only runtime script repair candidate (no ESP/voice replacement):
  - Recompiled and deployed `QF_COMAstra_00000805.pex` from:
    - `Tools/Papyrus/Fragments/Quests/QF_COMAstra_00000805.psc`
  - Removed runtime type-link failure source by using fragment script without `COMClaudeScript` autocast in stage 150.
  - Added script property alignment:
    - `FollowerEndgameForceGreetOn` property added to `QF_COMAstra_00000805.psc` to match quest VMAD property initialization.
    - Corrected property type to `ActorValue` (not `GlobalVariable`) to match quest VMAD binding target.
  - Deployed files:
    - `Data/Scripts/Fragments/Quests/QF_COMAstra_00000805.pex` (new compile)
    - `Data/Scripts/Source/User/Fragments/Quests/QF_COMAstra_00000805.psc`
    - `Data/Scripts/Source/User/QF_COMAstra_00000805.psc`
  - Intent: fix dismiss reliability without altering the currently working voice pack/pickup behavior.
  - Checkpoint folder:
    - `<WORKSPACE_ROOT>/ChatGPT/CompanionAstra/Backups/WorkingHistory/2026-02-17_1936_dismiss_pex_fix_candidate`
  - ZIP + hash:
    - `<WORKSPACE_ROOT>/Backups/DH/CompanionAstra_disaster_backup_20260217_dpex1.zip`
    - `<WORKSPACE_ROOT>/Backups/DH/CompanionAstra_disaster_backup_20260217_dpex1.zip.sha256`
- Backup workflow hardening:
  - Upgraded `Tools/create_working_checkpoint.ps1` to capture:
    - source + changelog + build artifact
    - deployed game artifacts (`ESP`/`PEX`/`PSC`)
    - optional deployed voice pack copy (`-IncludeVoice`)
    - latest Papyrus log and `Plugins.txt`
    - SHA256 fingerprints and voice counts in manifest
    - structured `NOTES_THIS_BUILD.md` (`Intent/Worked/Broken/Changed/Hypothesis/NextStep`)
  - Updated docs:
    - `docs/BACKUP_WORKFLOW.md`
  - Created checkpoint with full notes for current stable state:
    - `<WORKSPACE_ROOT>/ChatGPT/CompanionAstra/Backups/WorkingHistory/2026-02-17_195509_2026-02-17_voice_pickup_dismiss_affinity_reset_o`
- One-attempt handoff exchange test build (2026-02-17 night):
  - Built isolated candidate ESP from recovered Feb-16 source with minimal change:
    - Alias 1 (`Companion`) set to external link -> `Followers` quest alias `0`
    - Alias 2 (`Dogmeat`) set to external link -> `Followers` quest alias `5`
  - Deployed **ESP only** (no script/voice replacement in this attempt):
    - `Data/CompanionAstra.esp` SHA256 `4C94DEE08735837FA2B6538B732DDDFB6A7BDC1DCD54A2290C4CCA98E606894B`
  - Pre-deploy rollback backup:
    - `<WORKSPACE_ROOT>/Backups/OneAttemptPreDeploy_2026-02-17_200023`
  - Full checkpoint (notes + deployed state):
    - `<WORKSPACE_ROOT>/ChatGPT/CompanionAstra/Backups/WorkingHistory/2026-02-17_200035_2026-02-17_one_attempt_handoff_alias_external`

## 2026-02-11
- Dismiss reliability update (hybrid routing):
  - Kept Piper-style `Scene/Enter` starter topic `COMAstraDismissEnter`.
  - Restored greeting-path dismiss fallback (`CurrentCompanionFaction == 1`) for command-wheel Talk reliability.
  - Renamed dismiss scene EditorID to `COMAstraDismissScene`.
- Actor VMAD parity pass (targeted, no deep-copy links):
  - Expanded `CompanionActorScript` on `CompanionAstra` with high-impact properties:
    - `CA_Event_Murder`, `Experience`, `HasItemForPlayer`, `TemporaryAngerLevel`, `MurderToggle`
    - `StartingThreshold`, `InfatuationThreshold`, `MQComplete`, `Tutorial`, `ShouldGivePlayerItems`
  - Added `workshopnpcscript` with:
    - `WorkshopParent`, `bAllowCaravan=true`, `bAllowMove=true`, `bApplyWorkshopOwnerFaction=false`, `bCommandable=true`
  - Verified via local inspector: `RESULT: PASS` for required actor script/property presence.
- Rebuilt and redeployed current test artifacts:
  - `CompanionAstra.esp`
  - `QF_COMAstra_Test_000009A1.psc`
  - `QF_COMAstra_Test_000009A1.pex`
- Fixed true scene phase mismatch warning:
  - `COMClaude_11_InfatuationRepeaterRegular` Action 3 start-scene label now matches index 10 in target scene:
    - `StartPhaseForScene: "Romance Gate"` -> `"Loop05"`
- Confirmed root cause for recurring INFO phase warnings:
  - Mutagen `DialogResponses` exposes `StartScene` + `StartScenePhase` only (no writable phase-index field).
  - CK warns when name/index drift exists and auto-normalizes on check-out/check-in.
- Active test quest identity is now:
  - `COMAstra_Test` FormKey `0009A1`
  - script `Fragments:Quests:QF_COMAstra_Test_000009A1`
- Added documentation set for ongoing wiki/encyclopedia/bible workflow:
  - `docs/WIKI_INDEX.md`
  - `docs/COMPANION_CREATION_BIBLE.md`
  - `docs/PAPYRUS_WORKFLOW.md`
  - `docs/BACKUP_WORKFLOW.md`
  - `docs/ACTOR_SCRIPT_PROPERTY_AUDIT.md`
- Added snapshot automation:
  - `Tools/create_build_snapshot.ps1`
  - Created snapshot: `Backups/2026-02-11_084347_good_build_2026-02-11_morning`

## 2026-02-10
- Added Piper-parity repeater affinity greetings for scenes 06/07/08/09/10 in `COMClaudeGreetings`.
- Added stable INFO IDs for repeater greetings: `00F640` to `00F648`.
- Added missing repeater condition globals on greetings:
  - `CA_Scene_Repeat_Admiration_Downward`
  - `CA_Scene_Repeat_Neutral_Downward`
  - `CA_Scene_Repeat_Disdain_Downward`
  - `CA_Scene_Repeat_Hatred_Downward`
  - `CA_Scene_Repeat_Infatuation_Upward`
- Matched vanilla condition shape:
  - paired greetings with `CA_WantsToTalk == 1` and `== 2`
  - scene 09 uses `CA_WantsToTalk >= 1`
  - scene 10 includes `GetStageDone(COMAstra, 420) == 1` on both greetings
- Rebuilt and deployed latest `CompanionAstra.esp` and synced quest fragment scripts (`QF_COMAstra_00000805`, `QF_COMAstra_Test_00000995`) to game `Data`.
- Expanded `COMAstra_Test` stage routing to include repeater scene tests:
  - stages `70-79` now directly trigger repeat scenes 06/07/08/09/10, including `WantsToTalk=2` reminder variants.
- Added repeat-scene globals to `COMAstra_Test` VMAD properties.
- Added in-game `Debug.Notification` feedback for repeater test stages and reset.
- Added `COMClaude_11_InfatuationRepeaterRegular` scene (Piper parity structure) and a matching greeting gate:
  - `CA_WantsToTalkRomanceRetry == 1`
  - `CA_CurrentThreshold == CA_T1_Infatuation`
- Added `COMAstra_Test` stage `80` to force the scene-11 greeting path for in-game testing.
- Wired scene-11 Action3 start-scene link to scene 03 romance gate:
  - scene: `COMClaude_03_AdmirationToInfatuation`
  - `PhaseIndex = 10`
  - `StartPhaseForScene = Romance Gate`
- Set scene-11 greeting start phase to `Loop01` for parity with Piper flow.
- Confirmed active test fragment script identity changed to `QF_COMAstra_Test_0000099F` and deployed:
  - `CompanionAstra.esp`
  - `QF_COMAstra_Test_0000099F.psc`
  - `QF_COMAstra_Test_0000099F.pex`
- Dismiss routing updated to Piper-style minimal parity:
  - Added `Scene/Enter` topic `COMAstraDismissEnter` that starts `COMAstraDismissScene`.
  - Dismiss starter uses `StartScenePhase = Loop01`.
  - Added back a greeting-path dismiss fallback for command-wheel Talk reliability.
- Pickup greeting starters now explicitly use `StartScenePhase = Loop01` (both first-time and returning).
- Renamed dismiss scene EditorID from `COMClaudeDismissScene` to `COMAstraDismissScene` for consistency.
- Current test quest script identity is now `QF_COMAstra_Test_000009A1` and deployed with matching `.psc/.pex`.

## 2026-02-08
- Locked Neutral -> Friendship INFO IDs to stable range `0000F200` - `0000F223`.
- Softened Neutral -> Friendship player negative response to "Maybe later."
- Rebuilt LockedIDs generator with fixed INFO IDs.
- Updated greeting stability doc with locked ranges and corrected paths.
- Added guardrail to prevent overwriting Neutral -> Friendship NPC audio unless explicitly allowed.
- Added `--enable-friendship-tts` to generate Astra TTS for Neutral -> Friendship NPC lines.
- Locked Neutral -> Friendship greetings to `0000F230` - `0000F231` and generated Astra TTS.
- Mapped Neutral -> Friendship player lines to closest vanilla player voice files (see doc for IDs).
- Updated Neutral -> Friendship player text to match selected vanilla player audio exactly.
- Locked Friendship -> Admiration INFO IDs and updated player text to match vanilla audio.
- Added admiration TTS generation flag and guardrail against overwriting admiration NPC audio.
- Added second admiration greeting and locked its INFO ID.
- Restored admiration player text to Astra-first phrasing; mapped closest vanilla player audio without changing text.
- Locked Confidant INFO IDs and added second confidant greeting.
- Added confidant TTS generation flag and guardrail against overwriting confidant NPC audio.
- Locked Infatuation INFO IDs and added second infatuation greeting.
- Added infatuation TTS generation flag and guardrail against overwriting infatuation NPC audio.
- Added infatuation locked ID map doc.
- Locked Disdain + Hatred INFO IDs, added two greetings each, and updated greeting stability doc.
- Added Disdain/Hatred player voice mapping to closest vanilla lines.
- Added Disdain/Hatred TTS generation flags.
- Added Disdain/Hatred locked ID map doc.
- Locked Recovery/Murder INFO IDs and mapped player voice to closest vanilla lines.
- Added Recovery/Murder TTS generation flags.
- Added Recovery/Murder locked ID map doc.
- Guardrails now allow COMAstra/COMClaude fragment names and alias properties.
- Guardrails now use a configurable CompanionName/QuestEditorId pattern (Companion{Name}, COM{Name}).
- Fragment script now uses COM{Name} (QF_COMAstra_00000805) and Alias_Astra.

## 2026-02-07
- Fixed Fallout 4 `.fuz` layout (FUZE + version + lip + audio).
- Added Astra pickup scene text and TTS audio generation (Windows SAPI).
- Added companion/dogmeat phase conditions to pickup scene.
- Renamed quest to `COMAstra` and companion display name to Astra.
- Documented voice pipeline and CK behavior.
- Documented Piper-exact pickup scene replica and exact topic FormKeys.
- Documented greeting voice ID stability and the required ID dump workflow.

